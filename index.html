<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Alex English Academy</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles/app.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <div class="login-container">
            <div class="logo">
                <h1>Teacher Alex</h1>
                <p>English Academy</p>
            </div>
            
            <form id="login-form" class="login-form">
                <div class="form-group">
                    <input 
                        type="text" 
                        id="username" 
                        placeholder="Username"
                        autocomplete="username"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <input 
                        type="password" 
                        id="password" 
                        placeholder="Password"
                        autocomplete="current-password"
                        required
                    >
                </div>
                
                <button type="submit" class="btn-primary">
                    Enter Academy
                </button>
            </form>
            
            <div id="login-error" class="error-message"></div>
        </div>
    </div>

    <!-- App Shell (Hidden until login) -->
    <div id="app-screen" class="screen">
        <!-- Header -->
        <header class="app-header">
            <h1>Teacher Alex Academy</h1>
            <div class="user-info">
                <span id="user-name"></span>
                <button id="logout-btn" class="btn-small">Logout</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="main-nav">
            <button class="nav-item active" data-page="dashboard">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Dashboard</span>
            </button>
            <button class="nav-item" data-page="listening">
                <span class="nav-icon">üéß</span>
                <span class="nav-label">Listening</span>
            </button>
            <button class="nav-item" data-page="reading">
                <span class="nav-icon">üìñ</span>
                <span class="nav-label">Reading</span>
            </button>
            <button class="nav-item" data-page="progress">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Progress</span>
            </button>
        </nav>

        <!-- Content Area -->
        <main id="content" class="content">
            <!-- Dynamic content loads here -->
        </main>
    </div>

    <!-- Core JavaScript INLINE -->
    <script>
        // Teacher Alex Academy - Inline Solution
        // GUARANTEED to work!
        
        class StateManager {
            constructor() {
                this.state = {};
                this.storageKey = 'teacherAlex_state';
                this.load();
            }

            load() {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    if (saved) this.state = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load state:', e);
                }
            }

            save() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.state));
                } catch (e) {
                    console.error('Failed to save state:', e);
                }
            }

            get(path) {
                return path.split('.').reduce((obj, key) => obj?.[key], this.state);
            }

            set(path, value) {
                const keys = path.split('.');
                const lastKey = keys.pop();
                const target = keys.reduce((obj, key) => {
                    if (!obj[key]) obj[key] = {};
                    return obj[key];
                }, this.state);
                
                target[lastKey] = value;
                this.save();
            }
        }

        class Router {
            constructor() {
                this.routes = new Map();
                this.currentPage = null;
            }

            register(name, loader) {
                this.routes.set(name, loader);
            }

            async navigate(page) {
                const content = document.getElementById('content');
                const loader = this.routes.get(page);
                
                if (!loader) {
                    content.innerHTML = '<div class="error">Page not found</div>';
                    return;
                }

                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.page === page);
                });

                try {
                    content.innerHTML = '<div class="loading">Loading...</div>';
                    const html = await loader();
                    content.innerHTML = html;
                    this.currentPage = page;
                } catch (e) {
                    content.innerHTML = '<div class="error">Failed to load page</div>';
                    console.error(e);
                }
            }
        }

        class Auth {
            constructor() {
                this.users = {
                    'matheus': 'english090803',
                    'iasmin': 'english050307',
                    'leticia': 'english843892',
                    'larissa': 'english765352',
                    'ednei': 'english4536798',
                    'guilherme': 'english408698',
                    'leidson': 'english594367',
                    'tais': 'english194678',
                    'barbara': 'english847693',
                    'dudu': 'english136789',
                    'nicolete': 'liloestitch',
                    'iago': 'english987654',
                    'jaqueline': 'english74309',
                    'giovana': 'english987543',
                    'marina': 'english742387',
                    'breno': 'english345687',
                    'duda': 'english454356',
                    'kelli': 'english434567',
                    'lucas': 'english98765423',
                    'alex': 'teacher'
                };
            }

            login(username, password) {
                const user = username.toLowerCase().trim();
                if (this.users[user] === password) {
                    window.State.set('user', {
                        username: user,
                        loginTime: Date.now()
                    });
                    return true;
                }
                return false;
            }

            logout() {
                window.State.set('user', null);
            }

            isLoggedIn() {
                return !!window.State.get('user');
            }

            currentUser() {
                return window.State.get('user');
            }
        }

        // Initialize
        window.State = new StateManager();
        window.Router = new Router();
        window.Auth = new Auth();

        // Page Loaders
        window.Router.register('dashboard', async () => {
            const user = window.Auth.currentUser();
            const progress = window.State.get(`progress.${user.username}`) || {};
            
            return `
                <div class="dashboard">
                    <h2>Welcome back, ${user.username}!</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${progress.completedLessons || 0}</div>
                            <div class="stat-label">Lessons Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${progress.studyStreak || 0}</div>
                            <div class="stat-label">Day Streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${progress.totalPoints || 0}</div>
                            <div class="stat-label">Total Points</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${progress.level || 'Beginner'}</div>
                            <div class="stat-label">Current Level</div>
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button class="action-card" onclick="window.Router.navigate('listening')">
                            <span class="action-icon">üéß</span>
                            <span class="action-label">Continue Listening</span>
                        </button>
                        <button class="action-card" onclick="window.Router.navigate('reading')">
                            <span class="action-icon">üìñ</span>
                            <span class="action-label">Continue Reading</span>
                        </button>
                    </div>
                </div>
            `;
        });

        window.Router.register('listening', async () => {
            return `
                <div class="listening-hub">
                    <h2>Listening Practice</h2>
                    <div class="lesson-grid">
                        <div class="lesson-card">
                            <h3>Lesson 1: Introductions</h3>
                            <p>Learn basic greetings and introductions</p>
                            <button class="btn-primary">Start Lesson</button>
                        </div>
                    </div>
                </div>
            `;
        });

        window.Router.register('reading', async () => {
            return `
                <div class="reading-hub">
                    <h2>Reading Practice</h2>
                    <div class="lesson-grid">
                        <div class="lesson-card">
                            <h3>Story 1: The New Neighbor</h3>
                            <p>A1 Level - 500 words</p>
                            <button class="btn-primary">Read Story</button>
                        </div>
                    </div>
                </div>
            `;
        });

        window.Router.register('progress', async () => {
            const user = window.Auth.currentUser();
            const progress = window.State.get(`progress.${user.username}`) || {};
            
            return `
                <div class="progress-page">
                    <h2>Your Progress</h2>
                    <div class="progress-chart">
                        <p>Study time: ${progress.totalMinutes || 0} minutes</p>
                        <p>Achievements: ${progress.achievements?.length || 0}</p>
                    </div>
                </div>
            `;
        });

        // App Initialization - GUARANTEED TO RUN
        function initializeApp() {
            console.log('üöÄ App initializing...');
            
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            
            console.log('Elements found:', { loginForm, loginError });
            
            // Check if already logged in
            if (window.Auth.isLoggedIn()) {
                showApp();
            }
            
            // Login form handler - FORCED attachment
            loginForm.addEventListener('submit', handleLogin);
            
            function handleLogin(e) {
                e.preventDefault();
                console.log('üîë Login attempt...');
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                console.log('Credentials:', { username, password });
                
                if (window.Auth.login(username, password)) {
                    console.log('‚úÖ Login successful!');
                    showApp();
                } else {
                    console.log('‚ùå Login failed!');
                    loginError.textContent = 'Invalid username or password';
                    loginError.style.display = 'block';
                }
            }
            
            // Logout handler
            document.getElementById('logout-btn').addEventListener('click', () => {
                window.Auth.logout();
                showLogin();
            });
            
            // Navigation handler
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    window.Router.navigate(item.dataset.page);
                });
            });
            
            function showApp() {
                const user = window.Auth.currentUser();
                document.getElementById('user-name').textContent = user.username;
                loginScreen.classList.remove('active');
                appScreen.classList.add('active');
                window.Router.navigate('dashboard');
            }
            
            function showLogin() {
                loginScreen.classList.add('active');
                appScreen.classList.remove('active');
                loginForm.reset();
                loginError.style.display = 'none';
            }
            
            console.log('‚úÖ App initialized successfully!');
        }

        // Multiple initialization methods to ensure it runs
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Backup initialization
        window.addEventListener('load', () => {
            console.log('üîÑ Backup initialization...');
            if (!window.appInitialized) {
                initializeApp();
                window.appInitialized = true;
            }
        });

        // Global API
        window.TeacherAlex = {
            State: window.State,
            Router: window.Router,
            Auth: window.Auth,
            version: '2.1.0'
        };

        console.log('üìö Teacher Alex Academy loaded!');
    </script>
</body>
</html>
